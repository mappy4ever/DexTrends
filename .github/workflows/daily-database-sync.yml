name: Daily Database Sync

on:
  schedule:
    # Delta sync daily at 3 AM UTC (Mon-Sat)
    - cron: '0 3 * * 1-6'
    # Full sync on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      sync-type:
        description: 'What to sync'
        required: true
        type: choice
        options:
          - all
          - all-delta
          - pokemon-only
          - tcg-only
          - showdown-only
        default: all-delta

jobs:
  sync-pokemon-database:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: ${{ github.event.inputs.sync-type != 'tcg-only' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Determine sync mode
      id: mode
      run: |
        # Sunday = full sync, other days = delta
        DAY_OF_WEEK=$(date +%u)
        if [[ "${{ github.event.inputs.sync-type }}" == "all" ]]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "Running FULL sync (manual trigger)"
        elif [[ "${{ github.event.inputs.sync-type }}" == "all-delta" ]]; then
          echo "mode=delta" >> $GITHUB_OUTPUT
          echo "Running DELTA sync (manual trigger)"
        elif [[ "$DAY_OF_WEEK" == "7" ]]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "Running FULL sync (Sunday)"
        else
          echo "mode=delta" >> $GITHUB_OUTPUT
          echo "Running DELTA sync (weekday)"
        fi

    - name: Sync Pokemon data to Supabase
      run: |
        if [[ "${{ steps.mode.outputs.mode }}" == "delta" ]]; then
          npm run db:sync-pokemon-delta
        else
          npm run db:sync-pokemon
        fi
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    - name: Create summary
      run: |
        echo "## Pokemon Database Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Types, Natures, Berries synced" >> $GITHUB_STEP_SUMMARY
        echo "- Abilities synced" >> $GITHUB_STEP_SUMMARY
        echo "- Pokemon and Species synced" >> $GITHUB_STEP_SUMMARY
        echo "- Moves synced" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sync completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  sync-tcg-database:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: ${{ github.event.inputs.sync-type != 'pokemon-only' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Determine sync mode
      id: mode
      run: |
        DAY_OF_WEEK=$(date +%u)
        if [[ "${{ github.event.inputs.sync-type }}" == "all" ]]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "Running FULL sync (manual trigger)"
        elif [[ "${{ github.event.inputs.sync-type }}" == "all-delta" ]]; then
          echo "mode=delta" >> $GITHUB_OUTPUT
          echo "Running DELTA sync (manual trigger)"
        elif [[ "$DAY_OF_WEEK" == "7" ]]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "Running FULL sync (Sunday)"
        else
          echo "mode=delta" >> $GITHUB_OUTPUT
          echo "Running DELTA sync (weekday)"
        fi

    - name: Sync TCG data to Supabase
      run: |
        if [[ "${{ steps.mode.outputs.mode }}" == "delta" ]]; then
          npm run db:sync-delta
        else
          npm run db:sync-full
        fi
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    - name: Create summary
      run: |
        echo "## TCG Database Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- TCG Sets synced" >> $GITHUB_STEP_SUMMARY
        echo "- TCG Cards synced" >> $GITHUB_STEP_SUMMARY
        echo "- Pocket Sets synced" >> $GITHUB_STEP_SUMMARY
        echo "- Pocket Cards synced" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sync completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  sync-price-history:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # Run daily (every schedule) to capture price snapshots

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Sync price history to Supabase
      run: npm run db:sync-prices
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    - name: Create summary
      run: |
        echo "## Price History Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Daily price snapshots captured" >> $GITHUB_STEP_SUMMARY
        echo "- TCGPlayer (USD) prices recorded" >> $GITHUB_STEP_SUMMARY
        echo "- CardMarket (EUR) prices recorded" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sync completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  sync-showdown-database:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Run on Sundays OR when manually triggered with showdown-only/all
    if: ${{ github.event.inputs.sync-type == 'showdown-only' || github.event.inputs.sync-type == 'all' || (github.event_name == 'schedule' && github.event.schedule == '0 3 * * 0') }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Sync Showdown competitive data to Supabase
      run: npm run db:sync-showdown
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    - name: Create summary
      run: |
        echo "## Showdown Database Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Type Effectiveness synced" >> $GITHUB_STEP_SUMMARY
        echo "- Competitive Tiers synced (OU, UU, Ubers, etc.)" >> $GITHUB_STEP_SUMMARY
        echo "- Pokemon Learnsets synced" >> $GITHUB_STEP_SUMMARY
        echo "- Move Competitive Data synced" >> $GITHUB_STEP_SUMMARY
        echo "- Ability Ratings synced" >> $GITHUB_STEP_SUMMARY
        echo "- Items synced" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sync completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [sync-pokemon-database, sync-tcg-database, sync-price-history, sync-showdown-database]
    if: failure()

    steps:
    - name: Create issue for failure
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Database Sync Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The daily database sync has failed. Please check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\n**Affected jobs:**\n- Pokemon sync: Check logs\n- TCG sync: Check logs`,
            labels: ['bug', 'database', 'automated']
          });
