name: Daily Database Sync

on:
  schedule:
    # Run at 3 AM UTC every day (after scheduled tests at 2 AM)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      sync-type:
        description: 'What to sync'
        required: true
        type: choice
        options:
          - all
          - pokemon-only
          - tcg-only
        default: all

jobs:
  sync-pokemon-database:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: ${{ github.event.inputs.sync-type != 'tcg-only' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Sync Pokemon data to Supabase
      run: npm run db:sync-pokemon
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    - name: Create summary
      run: |
        echo "## Pokemon Database Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Types, Natures, Berries synced" >> $GITHUB_STEP_SUMMARY
        echo "- Abilities synced" >> $GITHUB_STEP_SUMMARY
        echo "- Pokemon and Species synced" >> $GITHUB_STEP_SUMMARY
        echo "- Moves synced" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sync completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  sync-tcg-database:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: ${{ github.event.inputs.sync-type != 'pokemon-only' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Sync TCG data to Supabase
      run: npm run db:sync-full
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    - name: Create summary
      run: |
        echo "## TCG Database Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- TCG Sets synced" >> $GITHUB_STEP_SUMMARY
        echo "- TCG Cards synced" >> $GITHUB_STEP_SUMMARY
        echo "- Pocket Sets synced" >> $GITHUB_STEP_SUMMARY
        echo "- Pocket Cards synced" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sync completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [sync-pokemon-database, sync-tcg-database]
    if: failure()

    steps:
    - name: Create issue for failure
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Database Sync Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The daily database sync has failed. Please check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\n**Affected jobs:**\n- Pokemon sync: Check logs\n- TCG sync: Check logs`,
            labels: ['bug', 'database', 'automated']
          });
