name: Daily Database Sync

on:
  schedule:
    # Daily sync at 3 AM UTC (every day)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      sync-type:
        description: 'What to sync'
        required: true
        type: choice
        options:
          - daily
          - full
          - pokemon-only
          - tcg-only
          - showdown-only
        default: daily

jobs:
  sync-pokemon-database:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: ${{ github.event.inputs.sync-type != 'tcg-only' && github.event.inputs.sync-type != 'showdown-only' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Determine sync mode
      id: mode
      run: |
        # Sunday = full sync, other days = delta
        DAY_OF_WEEK=$(date +%u)
        if [[ "${{ github.event.inputs.sync-type }}" == "full" ]]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "Running FULL sync (manual trigger)"
        elif [[ "$DAY_OF_WEEK" == "7" ]]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "Running FULL sync (Sunday)"
        else
          echo "mode=delta" >> $GITHUB_OUTPUT
          echo "Running DELTA sync (weekday)"
        fi

    - name: Sync Pokemon data to Supabase
      run: |
        if [[ "${{ steps.mode.outputs.mode }}" == "delta" ]]; then
          npm run db:sync-pokemon-delta
        else
          npm run db:sync-pokemon
        fi
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    - name: Create summary
      run: |
        echo "## Pokemon Database Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Types, Natures, Berries synced" >> $GITHUB_STEP_SUMMARY
        echo "- Abilities synced" >> $GITHUB_STEP_SUMMARY
        echo "- Pokemon and Species synced" >> $GITHUB_STEP_SUMMARY
        echo "- Moves synced" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sync completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  sync-tcg-database:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours - includes price sync now
    if: ${{ github.event.inputs.sync-type != 'pokemon-only' && github.event.inputs.sync-type != 'showdown-only' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Determine sync mode
      id: mode
      run: |
        # Sunday = full sync, other days = daily (new cards + all prices)
        DAY_OF_WEEK=$(date +%u)
        if [[ "${{ github.event.inputs.sync-type }}" == "full" ]]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "Running FULL sync (manual trigger)"
        elif [[ "$DAY_OF_WEEK" == "7" ]]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "Running FULL sync (Sunday)"
        else
          echo "mode=daily" >> $GITHUB_OUTPUT
          echo "Running DAILY sync (new cards + all prices)"
        fi

    - name: Sync TCG data + prices to Supabase
      run: |
        if [[ "${{ steps.mode.outputs.mode }}" == "full" ]]; then
          npm run db:sync-full
        else
          npm run db:sync-daily
        fi
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    - name: Create summary
      run: |
        echo "## TCG Database Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- TCG Sets synced" >> $GITHUB_STEP_SUMMARY
        echo "- TCG Cards synced" >> $GITHUB_STEP_SUMMARY
        echo "- **Price history recorded** (combined sync)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sync completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  sync-showdown-database:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Run on Sundays OR when manually triggered with showdown-only/full
    if: ${{ github.event.inputs.sync-type == 'showdown-only' || github.event.inputs.sync-type == 'full' || (github.event_name == 'schedule' && (contains(github.event.schedule, '0 3 * * 0') || false)) }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check if Sunday
      id: check-day
      run: |
        DAY_OF_WEEK=$(date +%u)
        if [[ "$DAY_OF_WEEK" == "7" ]] || [[ "${{ github.event.inputs.sync-type }}" == "showdown-only" ]] || [[ "${{ github.event.inputs.sync-type }}" == "full" ]]; then
          echo "should_run=true" >> $GITHUB_OUTPUT
        else
          echo "should_run=false" >> $GITHUB_OUTPUT
        fi

    - name: Sync Showdown competitive data to Supabase
      if: ${{ steps.check-day.outputs.should_run == 'true' }}
      run: npm run db:sync-showdown
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    - name: Create summary
      if: ${{ steps.check-day.outputs.should_run == 'true' }}
      run: |
        echo "## Showdown Database Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Type Effectiveness synced" >> $GITHUB_STEP_SUMMARY
        echo "- Competitive Tiers synced (OU, UU, Ubers, etc.)" >> $GITHUB_STEP_SUMMARY
        echo "- Pokemon Learnsets synced" >> $GITHUB_STEP_SUMMARY
        echo "- Move Competitive Data synced" >> $GITHUB_STEP_SUMMARY
        echo "- Ability Ratings synced" >> $GITHUB_STEP_SUMMARY
        echo "- Items synced" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sync completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [sync-pokemon-database, sync-tcg-database, sync-showdown-database]
    if: failure()

    steps:
    - name: Create issue for failure
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Database Sync Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The daily database sync has failed. Please check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\n**Affected jobs:**\n- Pokemon sync: Check logs\n- TCG sync: Check logs\n- Showdown sync: Check logs`,
            labels: ['bug', 'database', 'automated']
          });
